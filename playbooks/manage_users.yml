---

- hosts: myhosts
  name: Manage Users
  gather_facts: False

  #         WARNING!             WARNING!             WARNING!
  #
  # Carefully review all tasks and select what you need by using tags.
  # Running *ALL* tasks will have unintended consequences!
  #
  # Examples:
  # ansible-playbook manage_users.yml --tags listusers
  # ansible-playbook manage_users.yml --tags adduser
  # ansible-playbook manage_users.yml --tags updaterole
  # ansible-playbook manage_users.yml --tags updatepassword
  # ansible-playbook manage_users.yml --tags deleteuser
  #
  # User to add, modify or delete is defined in file group_vars/myhosts

  # Options available:
  #   ListUsers			Lists all users, including empty entries
  #   AddUser			Add user
  #   EnableUser		Enable user
  #   DiasbleUser		Disable user
  #   UpdateUserRole		Update user role
  #   UpdateUserPassword	Update user password
  #   DeleteUser		Delete user

  tasks:

  # ------------------------------------------------------------------------
  - name: Set output file
    include_tasks: set_output_file.yml type=Users
    tags: listusers

  - name: List all users
    local_action: >
       redfish category=UserManagement command=ListUsers baseuri={{baseuri}}
       user={{user}} password={{password}} 
    register: result
    tags: listusers

  - local_action: copy content={{ result | to_nice_json }}
       dest={{template}}.json
    tags: listusers

  # ------------------------------------------------------------------------
  # When adding a user, you must enable it afterwards
  - name: Add user
    local_action: >
       redfish category=UserManagement command=AddUser baseuri={{baseuri}}
       user={{user}} password={{password}} userid={{userid}}
       username={{username}} userpswd={{userpswd}} userrole={{userrole}}
    tags: adduser

  - name: Enable user
    local_action: >
       redfish category=UserManagement command=EnableUser baseuri={{baseuri}}
       user={{user}} password={{password}} userid={{userid}}
    tags: [enableuser, adduser]

  # ------------------------------------------------------------------------
  - name: Update user role
    local_action: >
       redfish category=UserManagement command=UpdateUserRole baseuri={{baseuri}}
       user={{user}} password={{password}} userid={{userid}}
       userrole={{userrole}}
    tags: updaterole

  # ------------------------------------------------------------------------
  - name: Update user password
    local_action: >
       redfish category=UserManagement command=UpdateUserPassword baseuri={{baseuri}}
       user={{user}} password={{password}} userid={{userid}}
       userpswd={{userpswd}}
    tags: updatepassword

  # ------------------------------------------------------------------------
  # Before a user can be deleted, it must first be disabled
  - name: Disable user
    local_action: >
       redfish category=UserManagement command=DisableUser baseuri={{baseuri}}
       user={{user}} password={{password}} userid={{userid}}
    tags: [disableuser, deleteuser]

  - name: Delete user
    local_action: >
       redfish category=UserManagement command=DeleteUser baseuri={{baseuri}}
       user={{user}} password={{password}} userid={{userid}}
    tags: deleteuser

